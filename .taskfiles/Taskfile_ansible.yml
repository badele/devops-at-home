---
version: '3'

env:

vars:
  ARGS: '{{ .ARGS | default "" }}'

tasks:
  deps:
    desc: Install Ansible Galaxy dependencies
    cmds:
    - ansible-galaxy install -r ansible/galaxy_requirements.yml
    - task: update-permissions

  play:
    desc: "Execute ansible playbook: Usage: [INVENTORY] [ARGS] <BOOK>"
    cmds:
    - ansible-playbook {{.ARGS}} ansible/playbooks/{{.BOOK}}.yml
    - task: update-permissions
    deps:
    - check-book

  ping:
    desc: Ping nodes
    cmds:
    - ansible all --one-line -m ping

  update-permissions:
    cmds:
    - docker run --rm -it -v ${GIT_ROOT}:/app  alpine chown -R $(id -u):$(id -g) /app
    deps:
    - check-git-root
    silent: true

  # Checks Parameters
  check-book:
    cmds:
    - cmd: test ! -z "{{.BOOK}}" || (echo "Please define BOOK parameter"; exit 1)
    silent: true

  check-git-root:
    cmds:
    - cmd: test ! -z "$GIT_ROOT" || (echo "Please define GIT_ROOT (with direnv)"; exit 1)
    silent: true
